<!-- apps/frontend/src/app/features/admin/users/user-detail/user-detail.component.html -->

<p-confirmDialog />

<section class="py-8">
  <div class="container-custom max-w-5xl">
    <!-- Back Button -->
    <a routerLink="/admin/usuarios" class="inline-flex items-center text-secondary hover:text-primary transition-colors mb-6">
      <i class="pi pi-arrow-left mr-2"></i>
      Voltar para usuários
    </a>

    @if (loading()) {
      <div class="glass-card p-8">
        <div class="flex items-center gap-6 mb-8">
          <p-skeleton shape="circle" size="6rem" />
          <div class="flex-1">
            <p-skeleton height="2rem" width="40%" styleClass="mb-2" />
            <p-skeleton height="1rem" width="30%" />
          </div>
        </div>
        <p-skeleton height="20rem" />
      </div>
    } @else if (user()) {
      <!-- User Header -->
      <div class="glass-card p-8 mb-6">
        <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
          <!-- Avatar -->
          @if (user()?.avatarUrl) {
            <img 
              [src]="user()?.avatarUrl" 
              [alt]="user()?.fullName"
              class="w-24 h-24 rounded-full object-cover border-4 border-primary/30"
            />
          } @else {
            <div class="w-24 h-24 rounded-full bg-gradient-mystical flex items-center justify-center text-3xl text-white">
              {{ (user()?.fullName ?? 'U').charAt(0).toUpperCase() }}
            </div>
          }

          <!-- Info -->
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-2">
              <h1 class="heading-1 text-primary">{{ user()?.fullName }}</h1>
              <p-tag 
                [value]="getRoleLabel(user()?.role ?? 'CLIENT')" 
                [severity]="getRoleSeverity(user()?.role ?? 'CLIENT')"
              />
            </div>
            <p class="text-secondary">{{ user()?.email }}</p>
            @if (user()?.phone) {
              <p class="text-secondary text-sm">{{ user()?.phone }}</p>
            }
          </div>

          <!-- Actions -->
          <div class="flex flex-col gap-2">
            <button 
              pButton 
              [class]="user()?.isActive ? 'btn-outline' : 'btn-primary'"
              (click)="toggleActive()"
            >
              <i class="pi" [class]="user()?.isActive ? 'pi-ban' : 'pi-check'" class="mr-2"></i>
              {{ user()?.isActive ? 'Desativar' : 'Ativar' }}
            </button>
            <button 
              pButton 
              class="btn-outline"
              (click)="toggleRole()"
            >
              <i class="pi pi-user-edit mr-2"></i>
              Alterar Tipo
            </button>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="glass-card p-4 text-center">
          <p class="text-3xl font-bold text-primary">{{ user()?._count?.orders || 0 }}</p>
          <p class="text-secondary text-sm">Pedidos</p>
        </div>
        <div class="glass-card p-4 text-center">
          <p class="text-3xl font-bold text-primary">{{ user()?._count?.readings || 0 }}</p>
          <p class="text-secondary text-sm">Leituras</p>
        </div>
        <div class="glass-card p-4 text-center">
          <p class="text-3xl font-bold text-primary">{{ user()?._count?.appointments || 0 }}</p>
          <p class="text-secondary text-sm">Agendamentos</p>
        </div>
        <div class="glass-card p-4 text-center">
          <p class="text-lg font-bold" [class]="user()?.isActive ? 'text-green-400' : 'text-red-400'">
            <i class="pi" [class]="user()?.isActive ? 'pi-check-circle' : 'pi-times-circle'" class="mr-1"></i>
            {{ user()?.isActive ? 'Ativo' : 'Inativo' }}
          </p>
          <p class="text-secondary text-sm">Status</p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="glass-card p-6">
        <p-tabs value="0">
          <p-tablist>
            <p-tab value="0">Informações</p-tab>
            <p-tab value="1">Pedidos</p-tab>
            <p-tab value="2">Leituras</p-tab>
          </p-tablist>
          <p-tabpanels>
          <!-- Info Tab -->
          <p-tabpanel value="0">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 py-4">
              <div>
                <label class="text-secondary text-sm">Nome Completo</label>
                <p class="text-primary font-medium">{{ user()?.fullName }}</p>
              </div>
              <div>
                <label class="text-secondary text-sm">Email</label>
                <p class="text-primary font-medium">{{ user()?.email }}</p>
              </div>
              <div>
                <label class="text-secondary text-sm">Telefone</label>
                <p class="text-primary font-medium">{{ user()?.phone || 'Não informado' }}</p>
              </div>
              <div>
                <label class="text-secondary text-sm">Data de Nascimento</label>
                <p class="text-primary font-medium">{{ formatDate(user()?.birthDate) }}</p>
              </div>
              <div>
                <label class="text-secondary text-sm">Data de Cadastro</label>
                <p class="text-primary font-medium">{{ formatDateTime(user()?.createdAt ?? '') }}</p>
              </div>
              <div>
                <label class="text-secondary text-sm">Tipo de Conta</label>
                <p class="text-primary font-medium">{{ getRoleLabel(user()?.role ?? 'CLIENT') }}</p>
              </div>
            </div>
          </p-tabpanel>

          <!-- Orders Tab -->
          <p-tabpanel value="1">
            @if (user()?.orders?.length) {
              <div class="space-y-3 py-4">
                @for (order of user()?.orders ?? []; track order.id) {
                  <a 
                    [routerLink]="['/admin/pedidos', order.id]"
                    class="flex items-center justify-between p-4 bg-dark/30 rounded-lg hover:bg-dark/50 transition-colors"
                  >
                    <div>
                      <p class="text-primary font-medium">#{{ order.orderNumber }}</p>
                      <p class="text-secondary text-sm">{{ formatDateTime(order.createdAt) }}</p>
                    </div>
                    <div class="text-right">
                      <p class="text-accent font-bold">{{ order.total | currencyBrl }}</p>
                      <span class="text-xs text-secondary">{{ order.status }}</span>
                    </div>
                  </a>
                }
              </div>
            } @else {
              <p class="text-secondary text-center py-8">Nenhum pedido encontrado</p>
            }
          </p-tabpanel>

          <!-- Readings Tab -->
          <p-tabpanel value="2">
            @if (user()?.readings?.length) {
              <div class="space-y-3 py-4">
                @for (reading of user()?.readings ?? []; track reading.id) {
                  <a 
                    [routerLink]="['/admin/leituras', reading.id]"
                    class="flex items-center justify-between p-4 bg-dark/30 rounded-lg hover:bg-dark/50 transition-colors"
                  >
                    <div>
                      <p class="text-primary font-medium">{{ reading.product?.name }}</p>
                      <p class="text-secondary text-sm">{{ formatDateTime(reading.createdAt) }}</p>
                    </div>
                    <span class="text-xs text-secondary">{{ reading.status }}</span>
                  </a>
                }
              </div>
            } @else {
              <p class="text-secondary text-center py-8">Nenhuma leitura encontrada</p>
            }
          </p-tabpanel>
          </p-tabpanels>
        </p-tabs>
      </div>
    }
  </div>
</section>
