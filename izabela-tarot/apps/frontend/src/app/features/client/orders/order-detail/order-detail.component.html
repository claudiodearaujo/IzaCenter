<!-- apps/frontend/src/app/features/client/orders/order-detail/order-detail.component.html -->

<section class="py-8">
  <div class="container-custom max-w-4xl">
    <!-- Back Button -->
    <a routerLink="/cliente/pedidos" class="inline-flex items-center text-secondary hover:text-primary transition-colors mb-6">
      <i class="pi pi-arrow-left mr-2"></i>
      Voltar para pedidos
    </a>

    @if (loading()) {
      <!-- Loading State -->
      <div class="glass-card p-8">
        <p-skeleton height="2rem" width="40%" styleClass="mb-4" />
        <p-skeleton height="1rem" width="60%" styleClass="mb-8" />
        <p-skeleton height="8rem" styleClass="mb-4" />
        <p-skeleton height="8rem" />
      </div>
    } @else if (error()) {
      <!-- Error State -->
      <div class="glass-card p-12 text-center">
        <i class="pi pi-exclamation-triangle text-5xl text-red-400 mb-4"></i>
        <h2 class="heading-2 text-primary mb-4">Erro ao carregar pedido</h2>
        <p class="text-secondary mb-6">{{ error() }}</p>
        <a routerLink="/cliente/pedidos" class="btn-primary inline-block">
          Voltar para Pedidos
        </a>
      </div>
    } @else if (order()) {
      <!-- Order Header -->
      <div class="glass-card p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 class="heading-1 text-primary mb-2">
              Pedido #{{ order()?.orderNumber }}
            </h1>
            <p class="text-secondary">
              Realizado em {{ formatDate(order()!.createdAt) }}
            </p>
          </div>
          <span 
            class="inline-block px-4 py-2 rounded-lg text-sm font-medium border"
            [class]="getStatusClass(order()!.status)"
          >
            {{ getStatusLabel(order()!.status) }}
          </span>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Order Items -->
        <div class="lg:col-span-2 space-y-4">
          <h2 class="heading-3 text-primary">Itens do Pedido</h2>

          @for (item of order()?.items; track item.id) {
            <div class="glass-card p-6">
              <div class="flex gap-4">
                <!-- Product Image -->
                <div class="flex-shrink-0 w-20 h-20">
                  @if (item.product.coverImageUrl) {
                    <img 
                      [src]="item.product.coverImageUrl" 
                      [alt]="item.product.name"
                      class="w-full h-full object-cover rounded-lg"
                    />
                  } @else {
                    <div class="w-full h-full bg-gradient-mystical rounded-lg flex items-center justify-center">
                      <i class="pi pi-star text-white/50 text-xl"></i>
                    </div>
                  }
                </div>

                <!-- Product Info -->
                <div class="flex-1">
                  <div class="flex items-start justify-between">
                    <div>
                      <h3 class="text-primary font-bold text-lg">{{ item.product.name }}</h3>
                      <p class="text-secondary text-sm">
                        {{ getProductTypeLabel(item.product.type) }} • Qtd: {{ item.quantity }}
                      </p>
                    </div>
                    <p class="text-accent font-bold">{{ item.price * item.quantity | currencyBrl }}</p>
                  </div>

                  <!-- Questions -->
                  @if (item.questions && item.questions.length > 0) {
                    <div class="mt-4 p-3 bg-dark/30 rounded-lg">
                      <p class="text-secondary text-xs mb-1">Perguntas enviadas:</p>
                      @for (question of item.questions; track $index) {
                        <p class="text-primary text-sm italic">"{{ question }}"</p>
                      }
                    </div>
                  }

                  <!-- Reading Link -->
                  @if (item.reading) {
                    <div class="mt-4 flex items-center gap-4">
                      <span 
                        class="inline-block px-3 py-1 rounded-full text-xs font-medium"
                        [class]="getStatusClass(item.reading.status)"
                      >
                        Leitura: {{ getStatusLabel(item.reading.status) }}
                      </span>
                      @if (item.reading.status === 'PUBLISHED') {
                        <a 
                          [routerLink]="['/cliente/leituras', item.reading.id]"
                          class="text-accent hover:text-accent-light transition-colors text-sm"
                        >
                          Ver leitura <i class="pi pi-arrow-right ml-1"></i>
                        </a>
                      }
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Order Summary -->
        <div class="space-y-6">
          <!-- Payment Info -->
          <div class="glass-card p-6">
            <h3 class="heading-4 text-primary mb-4 flex items-center gap-2">
              <i class="pi pi-credit-card"></i>
              Pagamento
            </h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-secondary">Método:</span>
                <span class="text-primary">{{ getPaymentLabel(order()?.paymentMethod) }}</span>
              </div>
              @if (order()?.paidAt) {
                <div class="flex justify-between">
                  <span class="text-secondary">Pago em:</span>
                  <span class="text-primary">{{ formatDate(order()!.paidAt!) }}</span>
                </div>
              }
            </div>
          </div>

          <!-- Totals -->
          <div class="glass-card p-6">
            <h3 class="heading-4 text-primary mb-4 flex items-center gap-2">
              <i class="pi pi-wallet"></i>
              Resumo
            </h3>
            <div class="space-y-3 pb-4 border-b border-primary/10">
              <div class="flex justify-between">
                <span class="text-secondary">Subtotal:</span>
                <span class="text-primary">{{ order()?.subtotal | currencyBrl }}</span>
              </div>
              @if (order()?.discount && order()!.discount > 0) {
                <div class="flex justify-between">
                  <span class="text-secondary">Desconto:</span>
                  <span class="text-accent">-{{ order()?.discount | currencyBrl }}</span>
                </div>
              }
            </div>
            <div class="flex justify-between pt-4">
              <span class="text-primary font-bold">Total:</span>
              <span class="text-accent font-bold text-xl">{{ order()?.total | currencyBrl }}</span>
            </div>
          </div>

          <!-- Notes -->
          @if (order()?.notes) {
            <div class="glass-card p-6">
              <h3 class="heading-4 text-primary mb-4 flex items-center gap-2">
                <i class="pi pi-info-circle"></i>
                Observações
              </h3>
              <p class="text-secondary">{{ order()?.notes }}</p>
            </div>
          }

          <!-- Help -->
          <div class="glass-card p-6 text-center">
            <i class="pi pi-question-circle text-3xl text-primary mb-3"></i>
            <p class="text-secondary text-sm mb-3">
              Dúvidas sobre seu pedido?
            </p>
            <a routerLink="/contato" class="btn-outline text-sm">
              Fale Conosco
            </a>
          </div>
        </div>
      </div>
    }
  </div>
</section>
