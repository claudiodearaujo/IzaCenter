<!-- apps/frontend/src/app/features/admin/readings/reading-form/reading-form.component.html -->

<section class="py-8">
  <div class="container-custom max-w-6xl">
    <!-- Back Button -->
    <a routerLink="/admin/leituras" class="inline-flex items-center text-secondary hover:text-primary transition-colors mb-6">
      <i class="pi pi-arrow-left mr-2"></i>
      Voltar para leituras
    </a>

    @if (loading()) {
      <div class="glass-card p-8">
        <div class="animate-pulse space-y-4">
          <div class="h-10 bg-primary/10 rounded w-1/2"></div>
          <div class="h-32 bg-primary/10 rounded"></div>
          <div class="h-32 bg-primary/10 rounded"></div>
        </div>
      </div>
    } @else if (reading()) {
      <!-- Header -->
      <div class="glass-card p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <div class="flex items-center gap-3 mb-2">
              <h1 class="heading-1 text-primary">
                Leitura para {{ reading()?.client?.fullName }}
              </h1>
              <p-tag 
                [value]="getStatusLabel(reading()!.status)" 
                [severity]="getStatusSeverity(reading()!.status)"
              />
            </div>
            <p class="text-secondary">{{ reading()?.orderItem?.product?.name }}</p>
            <p class="text-secondary/60 text-sm">Criado em {{ formatDate(reading()!.createdAt) }}</p>
          </div>

          <div class="flex gap-3">
            @if (reading()?.status !== 'PUBLISHED') {
              <button 
                pButton 
                class="btn-outline"
                [loading]="saving()"
                (click)="saveReading()"
              >
                <i class="pi pi-save mr-2"></i>
                Salvar Rascunho
              </button>
              <button 
                pButton 
                class="btn-primary"
                [loading]="publishing()"
                (click)="publishReading()"
              >
                <i class="pi pi-send mr-2"></i>
                Publicar
              </button>
            }
          </div>
        </div>
      </div>

      <!-- Questions -->
      @if (reading()?.orderItem?.clientQuestions && reading()!.orderItem!.clientQuestions.length > 0) {
        <div class="glass-card p-6 mb-6 bg-gradient-to-r from-accent/10 to-purple-600/10">
          <h3 class="heading-3 text-primary mb-4 flex items-center gap-2">
            <i class="pi pi-question-circle"></i>
            Perguntas do Cliente
          </h3>
          <div class="space-y-3">
            @for (question of reading()!.orderItem!.clientQuestions; track $index) {
              <div class="p-4 bg-dark/30 rounded-lg">
                <span class="text-accent text-sm">Pergunta {{ $index + 1 }}:</span>
                <p class="text-primary italic mt-1">"{{ question }}"</p>
              </div>
            }
          </div>
        </div>
      }

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Title -->
          <div class="glass-card p-6">
            <label for="title" class="block text-secondary text-sm mb-2">
              Título da Leitura (opcional)
            </label>
            <input 
              pInputText 
              id="title"
              [(ngModel)]="form.title"
              class="w-full"
              placeholder="Ex: Leitura sobre Amor e Relacionamentos"
              [disabled]="reading()?.status === 'PUBLISHED'"
            />
          </div>

          <!-- Introduction -->
          <div class="glass-card p-6">
            <label class="block text-secondary text-sm mb-2">
              Introdução (opcional)
            </label>
            <textarea 
              pInputTextarea 
              [(ngModel)]="form.introduction"
              [rows]="4"
              class="w-full"
              placeholder="Uma breve introdução para a leitura..."
              [disabled]="reading()?.status === 'PUBLISHED'"
            ></textarea>
          </div>

          <!-- Cards Section -->
          <div class="glass-card p-6">
            <div class="flex items-center justify-between mb-6">
              <h3 class="heading-3 text-primary">Cartas</h3>
              @if (reading()?.status !== 'PUBLISHED') {
                <button 
                  pButton 
                  class="btn-outline"
                  (click)="openCardDialog()"
                >
                  <i class="pi pi-plus mr-2"></i>
                  Adicionar Carta
                </button>
              }
            </div>

            @if (selectedCards().length === 0) {
              <div class="text-center py-8 border-2 border-dashed border-primary/20 rounded-lg">
                <i class="pi pi-th-large text-4xl text-secondary/30 mb-4"></i>
                <p class="text-secondary">Nenhuma carta adicionada</p>
                @if (reading()?.status !== 'PUBLISHED') {
                  <button 
                    pButton 
                    class="btn-outline mt-4"
                    (click)="openCardDialog()"
                  >
                    Adicionar Carta
                  </button>
                }
              </div>
            } @else {
              <div class="space-y-6">
                @for (card of selectedCards(); track $index) {
                  <div class="p-4 bg-dark/30 rounded-lg">
                    <div class="flex gap-4">
                      <!-- Card Image -->
                      <div class="flex-shrink-0 w-24">
                        @if (card.card?.imageUrl) {
                          <img 
                            [src]="card.card.imageUrl" 
                            [alt]="card.card.name"
                            class="w-full rounded-lg cursor-pointer"
                            (click)="openCardDialog($index)"
                          />
                        } @else {
                          <div 
                            class="w-full aspect-[2/3] bg-gradient-mystical rounded-lg flex items-center justify-center cursor-pointer"
                            (click)="openCardDialog($index)"
                          >
                            <i class="pi pi-star text-white/50 text-2xl"></i>
                          </div>
                        }
                      </div>

                      <!-- Card Content -->
                      <div class="flex-1">
                        <div class="flex items-start justify-between mb-3">
                          <div>
                            <input 
                              pInputText 
                              [value]="card.positionName"
                              (input)="updateCardPositionName($index, $any($event.target).value)"
                              class="text-sm mb-1"
                              placeholder="Nome da posição"
                              [disabled]="reading()?.status === 'PUBLISHED'"
                            />
                            <h4 class="text-primary font-bold">{{ card.card?.name }}</h4>
                          </div>
                          @if (reading()?.status !== 'PUBLISHED') {
                            <button 
                              pButton 
                              class="p-button-text p-button-danger"
                              (click)="removeCard($index)"
                            >
                              <i class="pi pi-trash"></i>
                            </button>
                          }
                        </div>

                        <textarea 
                          pInputTextarea 
                          [value]="card.interpretation"
                          (input)="updateCardInterpretation($index, $any($event.target).value)"
                          [rows]="3"
                          class="w-full"
                          placeholder="Interpretação desta carta para o cliente..."
                          [disabled]="reading()?.status === 'PUBLISHED'"
                        ></textarea>
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- General Interpretation -->
          <div class="glass-card p-6">
            <label class="block text-secondary text-sm mb-2">
              Interpretação Geral *
            </label>
            <p-editor 
              [(ngModel)]="form.interpretation"
              [style]="{'height':'200px'}"
              [readonly]="reading()?.status === 'PUBLISHED'"
            />
          </div>

          <!-- Advice -->
          <div class="glass-card p-6">
            <label class="block text-secondary text-sm mb-2">
              Conselho (opcional)
            </label>
            <textarea 
              pInputTextarea 
              [(ngModel)]="form.advice"
              [rows]="4"
              class="w-full"
              placeholder="Um conselho ou orientação para o cliente..."
              [disabled]="reading()?.status === 'PUBLISHED'"
            ></textarea>
          </div>

          <!-- Conclusion -->
          <div class="glass-card p-6">
            <label class="block text-secondary text-sm mb-2">
              Conclusão (opcional)
            </label>
            <textarea 
              pInputTextarea 
              [(ngModel)]="form.conclusion"
              [rows]="4"
              class="w-full"
              placeholder="Palavras finais para encerrar a leitura..."
              [disabled]="reading()?.status === 'PUBLISHED'"
            ></textarea>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Client Info -->
          <div class="glass-card p-6">
            <h3 class="heading-4 text-primary mb-4">Cliente</h3>
            <p class="text-primary font-medium">{{ reading()?.client?.fullName }}</p>
            <p class="text-secondary text-sm">{{ reading()?.client?.email }}</p>
          </div>

          <!-- Audio -->
          <div class="glass-card p-6">
            <h3 class="heading-4 text-primary mb-4">Áudio (opcional)</h3>

            @if (reading()?.audioUrl) {
              <audio 
                [src]="reading()?.audioUrl" 
                controls 
                class="w-full mb-4"
              ></audio>
            }

            @if (reading()?.status !== 'PUBLISHED') {
              <p-fileUpload 
                mode="basic" 
                name="audio"
                accept="audio/*"
                [maxFileSize]="50000000"
                [auto]="true"
                chooseLabel="Enviar Áudio"
                [customUpload]="true"
                (uploadHandler)="onAudioUpload($event)"
                styleClass="w-full"
              />
              <p class="text-secondary/60 text-xs mt-2">
                MP3, WAV ou M4A. Máximo 50MB.
              </p>
            }
          </div>

          <!-- Actions -->
          @if (reading()?.status !== 'PUBLISHED') {
            <div class="glass-card p-6">
              <button 
                pButton 
                class="btn-outline w-full mb-3"
                [loading]="saving()"
                (click)="saveReading()"
              >
                <i class="pi pi-save mr-2"></i>
                Salvar Rascunho
              </button>
              <button 
                pButton 
                class="btn-primary w-full"
                [loading]="publishing()"
                (click)="publishReading()"
              >
                <i class="pi pi-send mr-2"></i>
                Publicar Leitura
              </button>
              <p class="text-secondary/60 text-xs mt-3 text-center">
                Ao publicar, o cliente será notificado por email
              </p>
            </div>
          }
        </div>
      </div>
    }
  </div>
</section>

<!-- Card Selection Dialog -->
<p-dialog 
  [(visible)]="cardDialogVisible"
  [modal]="true"
  [closable]="true"
  [style]="{width: '80vw', maxWidth: '900px'}"
  header="Selecionar Carta"
>
  <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 p-4 max-h-[60vh] overflow-y-auto">
    @for (card of availableCards(); track card.id) {
      <div 
        class="cursor-pointer transition-transform hover:scale-105"
        (click)="selectCard(card)"
      >
        @if (card.imageUrl) {
          <img 
            [src]="card.imageUrl" 
            [alt]="card.name"
            class="w-full rounded-lg mb-2"
          />
        } @else {
          <div class="w-full aspect-[2/3] bg-gradient-mystical rounded-lg flex items-center justify-center mb-2">
            <i class="pi pi-star text-white/50 text-xl"></i>
          </div>
        }
        <p class="text-primary text-sm text-center">{{ card.name }}</p>
      </div>
    }
  </div>
</p-dialog>
